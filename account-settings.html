<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Settings - 4D Signs</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header class="main-header">
        <div class="header-content">
            <div class="left-section">
                <div class="profile-dropdown">
                    <button class="profile-btn" id="profile-btn"><img src="https://via.placeholder.com/32x32/FFD700/28263A?text=U" alt="Profile" class="profile-img"></button>
            <div class="dropdown-menu" id="dropdown-menu">
                <a href="contact.html"><i class="fas fa-envelope"></i>Contact</a>
                <a href="account-settings.html"><i class="fas fa-cog"></i>Settings</a>
                <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i>Logout</a>
                    </div>
                </div>
                <a href="Homepage.html" class="logo">4D Signs</a>
            </div>
            <nav class="nav-bar">
                <a href="/4D-Signs/4Dsigns.php" class="nav-link"><i class="fas fa-home"></i> Home</a>
                <a href="/4D-Signs/customize.html" class="nav-link"><i class="fas fa-palette"></i> Customize</a>
                <a href="/4D-Signs/review.html" class="nav-link"><i class="fas fa-star"></i> <span>Orders/Reviews</span></a>
                <a href="/4D-Signs/cart.html" class="nav-link" title="Cart"><i class="fas fa-shopping-cart"></i></a>
                <a href="/4D-Signs/contact.html" class="nav-link" title="Contact"><i class="fas fa-envelope"></i></a>
            </nav>
        </div>
    </header>

    <main>
        <section class="account-settings-section">
            <div class="container">
                <div class="settings-header">
                    <h1><i class="fas fa-user-cog"></i> Account Settings</h1>
                    <p>Manage your account information and preferences</p>
                </div>

                <div class="settings-content">
                    <div class="settings-card">
                        <div class="card-header">
                            <h2><i class="fas fa-user"></i> Account Information</h2>
                        </div>
                        <div class="card-body">
                            <div class="account-info">
                                <div class="info-item">
                                    <label>Username:</label>
                                    <span id="current-username">johndoe</span>
                                </div>
                                <div class="info-item">
                                    <label>Email:</label>
                                    <span id="current-email">john.doe@example.com</span>
                                </div>
                                <div class="info-item">
                                    <label>Phone:</label>
                                    <span id="current-phone">N/A</span>
                                </div>
                                <div class="info-item">
                                    <label>Member Since:</label>
                                    <span id="member-since">January 2024</span>
                                </div>
                                <div class="info-item">
                                    <label>Account Status:</label>
                                    <span class="status-active">Active</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="settings-card">
                        <div class="card-header">
                            <h2><i class="fas fa-edit"></i> Update Account Details</h2>
                        </div>
                        <div class="card-body">
                            <form id="account-form" class="settings-form">
                                <div class="form-group">
                                    <label for="new-username">New Username:</label>
                                    <input type="text" id="new-username" name="username" placeholder="Enter new username">
                                    <small>Leave blank to keep current username</small>
                                </div>

                                <div class="form-group">
                                    <label for="current-password">Current Password:</label>
                                    <input type="password" id="current-password" name="current_password" placeholder="Enter current password" required>
                                </div>

                                <div class="form-group">
                                    <label for="new-password">New Password:</label>
                                    <input type="password" id="new-password" name="new_password" placeholder="Enter new password">
                                    <small>Leave blank to keep current password</small>
                                </div>

                                <div class="form-group">
                                    <label for="confirm-password">Confirm New Password:</label>
                                    <input type="password" id="confirm-password" name="confirm_password" placeholder="Confirm new password">
                                </div>

                                <div class="form-group">
                                    <label for="new-phone">Phone Number:</label>
                                    <input type="text" id="new-phone" name="phone" placeholder="09XXXXXXXXX or +63XXXXXXXXX">
                                    <small>Enter Philippine number; will be normalized to +63XXXXXXXXX</small>
                                </div>

                                <div class="form-actions">
                                    <button type="submit" class="btn-primary">Update Account</button>
                                    <button type="button" class="btn-secondary" onclick="resetForm()">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="settings-card danger-zone">
                        <div class="card-header">
                            <h2><i class="fas fa-exclamation-triangle"></i> Danger Zone</h2>
                        </div>
                        <div class="card-body">
                            <p>Once you delete your account, there is no going back. Please be certain.</p>
                            <button class="btn-danger" onclick="confirmDeleteAccount()">
                                <i class="fas fa-trash"></i> Delete Account
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="site-footer">
        <div class="footer-wrap">
            <div class="footer-col brand">
                <h3>4D signs</h3>
                <p>Your vision, our signs. Premium custom signage and souvenirs.</p>
                <div class="footer-social">
                    <a href="https://www.facebook.com/FourDsigns" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                    <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
            <nav class="footer-col links" aria-label="Footer navigation">
                <h4>Explore</h4>
                <ul>
                    <li><a href="Homepage.html">Home</a></li>
                        <li><a href="customize.html">Customize</a></li>
                        <li><a href="review.html"><span>Orders/Reviews</span></a></li>
                        <li><a href="cart.html">Cart</a></li>
                </ul>
            </nav>
            <div class="footer-col contact">
                <h4>Contact</h4>
                <ul>
                    <li><i class="fa fa-map-marker-alt"></i> 352 Zone 4 Tangos, Baliuag, Philippines, 3006</li>
                    <li><i class="fa fa-envelope"></i>cheriz20domingo@gmail.com</li>
                    <li><i class="fa fa-phone"></i> +63 917 582 5483</li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p>© <span id="footer-year"></span> 4D signs · All rights reserved</p>
        </div>
    </footer>

    <script>
// Profile dropdown functionality
document.getElementById('profile-btn').addEventListener('click', function(e) {
    e.stopPropagation();
    const menu = document.getElementById('dropdown-menu');
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
});

window.addEventListener('click', function(e) {
    if (!e.target.closest('.profile-dropdown')) {
        document.getElementById('dropdown-menu').style.display = 'none';
    }
});

function logout() {
    try { localStorage.removeItem('loggedInUser'); } catch(e) {}
    // Ensure the server-side session is cleared as well
    window.location.href = 'logout.php';
}

// Account settings functionality
document.getElementById('account-form').addEventListener('submit', function(e) {
    e.preventDefault();

    let loggedInUser = JSON.parse(localStorage.getItem('loggedInUser') || 'null');
    // If not found in localStorage, but serverAuth is present and serverUser is available, use it as fallback
    if (!loggedInUser && typeof window !== 'undefined' && typeof window.serverAuth !== 'undefined' && window.serverAuth === true && typeof window.serverUser !== 'undefined') {
        loggedInUser = window.serverUser;
                try { 
                    // Normalize serverUser keys to include loggedInAt for client code
                    const su = Object.assign({}, window.serverUser);
                    if (!su.loggedInAt && su.created_at) su.loggedInAt = su.created_at;
                    localStorage.setItem('loggedInUser', JSON.stringify(su));
                } catch(e) {}
    }
    if (!loggedInUser) {
        alert('Session expired. Please login again.');
    window.location.href = 'login.html';
        return;
    }

    const newUsername = document.getElementById('new-username').value.trim();
    const currentPassword = document.getElementById('current-password').value;
    const newPassword = document.getElementById('new-password').value;
    const confirmPassword = document.getElementById('confirm-password').value;
    const newPhone = document.getElementById('new-phone') ? document.getElementById('new-phone').value.trim() : '';

    // Basic validation
    if (!currentPassword) {
        alert('Please enter your current password.');
        return;
    }

    if (newPassword && newPassword !== confirmPassword) {
        alert('New passwords do not match.');
        return;
    }

    // Get all users and find current user using helper (by id, email, or username)
    const users = JSON.parse(localStorage.getItem('users') || '[]');
    function findUserIndex(loggedInfo) {
        if (!loggedInfo) return -1;
        // Prefer id
        if (typeof loggedInfo.id !== 'undefined') {
            const idx = users.findIndex(u => String(u.id) === String(loggedInfo.id));
            if (idx !== -1) return idx;
        }
        // try by email
        if (loggedInfo.email) {
            const idx = users.findIndex(u => u.email === loggedInfo.email);
            if (idx !== -1) return idx;
        }
        // try by username
        if (loggedInfo.username) {
            const idx = users.findIndex(u => u.username === loggedInfo.username);
            if (idx !== -1) return idx;
        }
        return -1;
    }

    let userIndex = findUserIndex(loggedInUser);
    if (userIndex === -1) {
        // If the user isn't in localStorage users, try to create/seed a local record using serverUser info
        if (typeof window !== 'undefined' && typeof window.serverAuth !== 'undefined' && window.serverAuth === true && typeof window.serverUser !== 'undefined') {
            // Build a minimal user object and add to users
            const seed = {
                id: window.serverUser.id || (Date.now()),
                username: window.serverUser.username || window.serverUser.email || ('user' + Date.now()),
                email: window.serverUser.email || '',
                password: '',
                phone: window.serverUser.phone || '',
                profile_pic_path: window.serverUser.profile_pic || '',
                created_at: window.serverUser.loggedInAt || window.serverUser.created_at || new Date().toISOString()
            };
            users.push(seed);
            localStorage.setItem('users', JSON.stringify(users));
            // Recompute userIndex
            const newIndex = findUserIndex(window.serverUser);
            if (newIndex !== -1) {
                userIndex = newIndex;
            } else {
                alert('Failed to create a local profile for your account. Please contact support.');
                return;
            }
        } else {
            // If not server-authenticated fallback, ask to login again
            alert('User record not found locally. Please log out and log in again.');
            window.location.href = 'login.html';
            return;
        }
    }

    const user = users[userIndex];

    // Verify current password (if we have a local password). If user is server-authenticated
    // and local password isn't present, allow the user to proceed (server will manage verification).
    if (user.password) {
        if (user.password !== currentPassword) {
            alert('Current password is incorrect.');
            return;
        }
    } else {
        // No local password (likely server-backed account). If server session exists, allow update.
        if (!(typeof window !== 'undefined' && typeof window.serverAuth !== 'undefined' && window.serverAuth === true)) {
            alert('Cannot verify your account locally; please re-login.');
            window.location.href = 'login.html';
            return;
        }
    }

    // Check if new username is already taken (if provided)
    if (newUsername && newUsername !== user.username) {
        const usernameExists = users.some(u => u.username === newUsername && u.id !== user.id);
        if (usernameExists) {
            alert('Username already exists. Please choose a different username.');
            return;
        }
        user.username = newUsername;
    }

    // Utility: normalize and validate phone
    function normalizePhoneNumber(phone) {
        if (!phone) return '';
        let p = phone.trim();
        // Remove spaces and common separators
        p = p.replace(/[^+0-9]/g, '');
        // Remove leading + if present for easier checks
        const plus = p.startsWith('+');
        if (plus) p = p.substring(1);
        // Now p is digits. Normalize:
        if (/^09\d{9}$/.test(p)) {
            // 09XXXXXXXXX -> +639XXXXXXXXX
            return '+63' + p.substring(1);
        }
        if (/^63\d{9}$/.test(p)) {
            return '+' + p;
        }
        if (/^9\d{9}$/.test(p)) {
            return '+63' + p;
        }
        // If already in +639XXXXXXXXX form
        if (/^639\d{9}$/.test(p)) return '+' + p;
        return null;
    }

    function isValidPhone(phone) {
        return normalizePhoneNumber(phone) !== null;
    }

    // Sanitize phone variable using normalizer for consistent storage
    const normalizedPhone = newPhone ? normalizePhoneNumber(newPhone) : '';
    // Update password if provided
    if (newPassword) {
        if (newPassword.length < 6) {
            alert('New password must be at least 6 characters long.');
            return;
        }
        user.password = newPassword;
    }

    // Update phone if provided
    if (newPhone) {
        if (!normalizedPhone) {
            alert('Please enter a valid Philippine phone number like 09XXXXXXXXX or +63XXXXXXXXX');
            return;
        }
        user.phone = normalizedPhone;
    }

    const updatedLoggedInUser = Object.assign({}, loggedInUser || {}, {
        id: user.id,
        username: user.username,
        email: user.email,
        phone: user.phone || '',
    });
    // Preserve the original loggedInAt if present
    if (loggedInUser && loggedInUser.loggedInAt) updatedLoggedInUser.loggedInAt = loggedInUser.loggedInAt;
    // If server-authenticated, call API to persist changes and update session
    if (typeof window !== 'undefined' && typeof window.serverAuth !== 'undefined' && window.serverAuth === true) {
        // Build payload
        const payload = {
            username: user.username,
            current_password: currentPassword,
            new_password: newPassword || '',
            phone: user.phone || ''
        };
        fetch('api/update-profile.php', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        }).then(r => r.json()).then(data => {
            if (!data || !data.success) {
                const msg = data && data.errors && data.errors.length ? data.errors.join(' | ') : 'Failed to update on server';
                alert('Server update failed: ' + msg);
                return;
            }
            // Update session and local storage with server values
            try { 
                const su = Object.assign({}, data.session_user);
                if (!su.loggedInAt && su.created_at) su.loggedInAt = su.created_at;
                localStorage.setItem('loggedInUser', JSON.stringify(su)); 
            } catch(e) {}
            // Update users[] stored locally if present
            users[userIndex] = Object.assign(users[userIndex] || {}, { username: data.session_user.username, phone: data.session_user.phone });
            localStorage.setItem('users', JSON.stringify(users));
            // Update display
            document.getElementById('current-username').textContent = data.session_user.username;
            if (document.getElementById('current-phone')) document.getElementById('current-phone').textContent = data.session_user.phone || 'N/A';
            const profileImg = document.querySelector('.profile-img');
            if (profileImg) {
                const initials = data.session_user.username.charAt(0).toUpperCase();
                profileImg.src = `https://via.placeholder.com/32x32/FFD700/28263A?text=${initials}`;
                profileImg.alt = `${data.session_user.username}'s profile`;
            }
            alert('Account settings updated successfully!');
            resetForm();
        }).catch(err => {
            console.error('Update profile request failed', err);
            alert('Server update failed: ' + err.message);
        });
        return; // stop local-only flow — we will update local state after server success
    }

    // Save updated user data locally when server not present
    users[userIndex] = user;
    localStorage.setItem('users', JSON.stringify(users));
    localStorage.setItem('loggedInUser', JSON.stringify(updatedLoggedInUser));

    // Update display
    document.getElementById('current-username').textContent = user.username;
    // Update profile image and alt if present
    const profileImg = document.querySelector('.profile-img');
    if (profileImg) {
        const initials = user.username.charAt(0).toUpperCase();
        profileImg.src = `https://via.placeholder.com/32x32/FFD700/28263A?text=${initials}`;
        profileImg.alt = `${user.username}'s profile`;
    }
    if (document.getElementById('current-phone')) document.getElementById('current-phone').textContent = user.phone || 'N/A';

    alert('Account settings updated successfully!');
    resetForm();
});

function resetForm() {
    const newPhoneEl = document.getElementById('new-phone');
    const preservePhone = newPhoneEl ? newPhoneEl.value : '';
    document.getElementById('account-form').reset();
    if (newPhoneEl && preservePhone) newPhoneEl.value = preservePhone;
}

function confirmDeleteAccount() {
    if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
        if (confirm('This will permanently delete your account and all associated data. Are you absolutely sure?')) {
            let loggedInUser = JSON.parse(localStorage.getItem('loggedInUser') || 'null');
            if (!loggedInUser && typeof window !== 'undefined' && typeof window.serverAuth !== 'undefined' && window.serverAuth === true && typeof window.serverUser !== 'undefined') {
                loggedInUser = window.serverUser;
            }
            if (!loggedInUser) {
                alert('Session expired.');
                return;
            }

            // Remove user from users array
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            function deleteFind(uinfo) {
                // delete by id, then email, then username
                if (uinfo.id) return u => String(u.id) === String(uinfo.id);
                if (uinfo.email) return u => u.email === uinfo.email;
                if (uinfo.username) return u => u.username === uinfo.username;
                return u => false;
            }
            const predicate = deleteFind(loggedInUser);
            const updatedUsers = users.filter(u => !predicate(u));
            localStorage.setItem('users', JSON.stringify(updatedUsers));

            // Clear logged in user data
            localStorage.removeItem('loggedInUser');

            alert('Account deleted successfully.');
            window.location.href = 'login.html';
        }
    }
}

    // Load saved username on page load
    document.addEventListener('DOMContentLoaded', async function() {
        // Fetch server session info (if any) and expose to client for pages that are static HTML
        if (!(typeof window !== 'undefined' && typeof window.serverAuth !== 'undefined' && window.serverAuth === true)) {
            try {
                const r = await fetch('debug/session.php', { credentials: 'include' });
                const data = await r.json();
                if (data && data.session_data && data.session_data.user_id) {
                    window.serverAuth = true;
                    window.serverUser = {
                        id: data.session_data.user_id,
                        username: data.session_data.username || data.session_data.email || '',
                        email: data.session_data.email || '',
                        phone: data.session_data.phone || '',
                        profile_pic: data.session_data.profile_pic || '',
                        loggedInAt: data.session_data.loggedInAt || data.session_data.created_at || ''
                    };
                    try { localStorage.setItem('loggedInUser', JSON.stringify(window.serverUser)); } catch(e) {}
                }
            } catch (e) { /* ignore */ }
        }
    let loggedInUser = JSON.parse(localStorage.getItem('loggedInUser') || 'null');
    if (!loggedInUser && typeof window !== 'undefined' && typeof window.serverAuth !== 'undefined' && window.serverAuth === true && typeof window.serverUser !== 'undefined') {
        loggedInUser = window.serverUser;
    }

    if (!loggedInUser) {
        alert('Please login first to access account settings.');
    window.location.href = 'login.html';
        return;
    }

    // Update profile button with user's initials
    const profileImg = document.querySelector('.profile-img');
    if (profileImg && loggedInUser.username) {
        const initials = loggedInUser.username.charAt(0).toUpperCase();
        profileImg.src = `https://via.placeholder.com/32x32/FFD700/28263A?text=${initials}`;
        profileImg.alt = `${loggedInUser.username}'s profile`;
    }

    // Display real user information
    document.getElementById('current-username').textContent = loggedInUser.username;
    document.getElementById('current-email').textContent = loggedInUser.email;
    const setPhone = (num) => { if (document.getElementById('current-phone')) document.getElementById('current-phone').textContent = num || 'N/A'; };

    // Ensure loggedInAt exists from created_at if needed (for older entries)
    if (loggedInUser && !loggedInUser.loggedInAt && loggedInUser.created_at) loggedInUser.loggedInAt = loggedInUser.created_at;
    // Attempt to load phone from loggedInUser or users array
    const phoneFromLogged = loggedInUser.phone || '';
    if (phoneFromLogged) {
        setPhone(phoneFromLogged);
        const el = document.getElementById('new-phone'); if (el && !el.value) el.value = phoneFromLogged;
    } else {
        // Try to find the user in the users list
        try {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const u = users.find(x => x.id === loggedInUser.id);
            if (u && u.phone) { setPhone(u.phone); const el = document.getElementById('new-phone'); if (el && !el.value) el.value = u.phone; }
            else setPhone('N/A');
        } catch(e) { setPhone('N/A'); }
    }

    // Format the member since date (if available)
    if (loggedInUser.loggedInAt) {
        // Normalize datetime string into ISO format accepted by Date
        const iso = String(loggedInUser.loggedInAt).replace(' ', 'T');
        const createdDate = new Date(iso);
        const memberSince = createdDate.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long'
        });
        document.getElementById('member-since').textContent = memberSince;
    } else {
        document.getElementById('member-since').textContent = 'Unknown';
    }

    document.getElementById('footer-year').textContent = new Date().getFullYear();
});
    </script>
</body>
</html>